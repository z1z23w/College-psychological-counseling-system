{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/%E8%BD%AF%E4%BB%B6%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%AE%9E%E9%AA%8C/my-counseling-app/components/ui/card.tsx"],"sourcesContent":["import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Card({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card\"\n      className={cn(\n        \"bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction CardHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-header\"\n      className={cn(\n        \"@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction CardTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-title\"\n      className={cn(\"leading-none font-semibold\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction CardDescription({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-description\"\n      className={cn(\"text-muted-foreground text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction CardAction({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-action\"\n      className={cn(\n        \"col-start-2 row-span-2 row-start-1 self-start justify-self-end\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction CardContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-content\"\n      className={cn(\"px-6\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction CardFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-footer\"\n      className={cn(\"flex items-center px-6 [.border-t]:pt-6\", className)}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardAction,\n  CardDescription,\n  CardContent,\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AAEA;;;AAEA,SAAS,KAAK,EAAE,SAAS,EAAE,GAAG,OAAoC;IAChE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,kHAAE,EACX,qFACA;QAED,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,kHAAE,EACX,4JACA;QAED,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,UAAU,EAAE,SAAS,EAAE,GAAG,OAAoC;IACrE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,kHAAE,EAAC,8BAA8B;QAC3C,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,gBAAgB,EAAE,SAAS,EAAE,GAAG,OAAoC;IAC3E,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,kHAAE,EAAC,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,kHAAE,EACX,kEACA;QAED,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,YAAY,EAAE,SAAS,EAAE,GAAG,OAAoC;IACvE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,kHAAE,EAAC,QAAQ;QACrB,GAAG,KAAK;;;;;;AAGf;AAEA,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,8OAAC;QACC,aAAU;QACV,WAAW,IAAA,kHAAE,EAAC,2CAA2C;QACxD,GAAG,KAAK;;;;;;AAGf"}},
    {"offset": {"line": 106, "column": 0}, "map": {"version":3,"sources":["file:///D:/%E8%BD%AF%E4%BB%B6%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%AE%9E%E9%AA%8C/my-counseling-app/app/actions.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { prisma } from \"@/lib/db\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\n// ==========================================\r\n// 1. 用户管理 (管理员用)\r\n// ==========================================\r\n\r\nexport async function getUsers() {\r\n  try {\r\n    const users = await prisma.user.findMany({\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n    return { success: true, data: users };\r\n  } catch (error) {\r\n    console.error(\"获取用户失败:\", error);\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\nexport async function createUser(formData: FormData) {\r\n  const name = formData.get(\"name\") as string;\r\n  const username = formData.get(\"username\") as string;\r\n  const role = formData.get(\"role\") as string;\r\n  const college = formData.get(\"college\") as string;\r\n\r\n  try {\r\n    await prisma.user.create({\r\n      data: {\r\n        name,\r\n        username,\r\n        role,\r\n        college,\r\n        password: \"123456\", // 默认密码\r\n        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`\r\n      },\r\n    });\r\n    revalidatePath(\"/admin/users\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"创建失败，学号可能已存在\" };\r\n  }\r\n}\r\n\r\nexport async function updateUser(id: string, formData: FormData) {\r\n  const name = formData.get(\"name\") as string;\r\n  const username = formData.get(\"username\") as string;\r\n  const role = formData.get(\"role\") as string;\r\n  const college = formData.get(\"college\") as string;\r\n\r\n  try {\r\n    await prisma.user.update({\r\n      where: { id },\r\n      data: { name, username, role, college },\r\n    });\r\n    revalidatePath(\"/admin/users\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"更新失败，学号可能冲突\" };\r\n  }\r\n}\r\n\r\nexport async function deleteUser(id: string) {\r\n  try {\r\n    await prisma.user.delete({ where: { id } });\r\n    revalidatePath(\"/admin/users\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"删除失败\" };\r\n  }\r\n}\r\n\r\n// ==========================================\r\n// 2. 认证与查询 (通用)\r\n// ==========================================\r\n\r\nexport async function loginAction(username: string, role: string) {\r\n  try {\r\n    const user = await prisma.user.findFirst({\r\n      where: { username, role }\r\n    });\r\n    if (!user) return { success: false, error: \"用户不存在或角色错误\" };\r\n    \r\n    // 返回用户信息（不含密码）\r\n    const { password, ...userInfo } = user;\r\n    return { success: true, data: userInfo };\r\n  } catch (error) {\r\n    return { success: false, error: \"数据库连接失败\" };\r\n  }\r\n}\r\n\r\nexport async function getCounselors() {\r\n  return await prisma.user.findMany({\r\n    where: { role: 'counselor' },\r\n    select: { id: true, name: true, college: true, avatar: true } // 明确选择需要的字段\r\n  });\r\n}\r\n\r\n// ==========================================\r\n// 3. 预约系统 (核心业务)\r\n// ==========================================\r\n\r\n// ✅ 修复：获取预约列表 (去除了 email 字段)\r\nexport async function getAppointments(userId: string, role: 'student' | 'counselor') {\r\n  const where = role === 'student' ? { studentId: userId } : { counselorId: userId };\r\n  \r\n  const data = await prisma.appointment.findMany({\r\n    where,\r\n    include: {\r\n      // ⚠️ 关键修改：User表没有email字段，改查 username(学号) 和 college\r\n      student: { select: { name: true, username: true, college: true, avatar: true } },\r\n      counselor: { select: { name: true, college: true, avatar: true } },\r\n      testResult: true, // 获取关联的测评结果\r\n    },\r\n    orderBy: { date: 'desc' }\r\n  });\r\n  return data;\r\n}\r\n\r\n// ✅ 创建带详细档案的预约\r\nexport async function createAppointmentWithDetails(data: any) {\r\n  // 检查时间冲突\r\n  const existing = await prisma.appointment.findFirst({\r\n    where: {\r\n      counselorId: data.counselorId,\r\n      date: new Date(data.date),\r\n      time: data.time,\r\n      status: 'confirmed' \r\n    }\r\n  });\r\n\r\n  if (existing) return { success: false, msg: \"该时段已被占用\" };\r\n\r\n  try {\r\n    await prisma.appointment.create({\r\n      data: {\r\n        studentId: data.studentId,\r\n        counselorId: data.counselorId,\r\n        date: new Date(data.date),\r\n        time: data.time,\r\n        // 详细信息\r\n        idCard: data.idCard,\r\n        studentIdNum: data.studentIdNum,\r\n        phone: data.phone,\r\n        college: data.college,\r\n        major: data.major,\r\n        grade: data.grade,\r\n        classInfo: data.classInfo,\r\n        mentalHistory: data.mentalHistory,\r\n        physicalState: data.physicalState,\r\n        problemType: data.problemType,\r\n        status: 'pending'\r\n      }\r\n    });\r\n\r\n    revalidatePath('/student/booking');\r\n    revalidatePath('/counselor/dashboard');\r\n    return { success: true };\r\n  } catch (e) {\r\n    console.error(e);\r\n    return { success: false, msg: \"预约创建异常\" };\r\n  }\r\n}\r\n\r\n// 更新预约状态 (审批/拒绝/完成)\r\nexport async function updateAppointmentStatus(id: string, status: string) {\r\n  await prisma.appointment.update({\r\n    where: { id },\r\n    data: { status }\r\n  });\r\n  revalidatePath(\"/counselor/dashboard\");\r\n  revalidatePath(\"/student/booking\");\r\n  return { success: true };\r\n}\r\n\r\n// 更新咨询记录 (咨询师写结案记录)\r\n// app/actions.ts\r\n\r\nexport async function updateConsultationRecord(id: string, notes: string) {\r\n  try {\r\n    await prisma.appointment.update({\r\n      where: { id },\r\n      data: { \r\n        notes, \r\n        status: 'completed' \r\n      }\r\n    });\r\n    revalidatePath(\"/counselor/dashboard\");\r\n    revalidatePath(\"/counselor/cases\"); // 确保刷新档案页面\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"保存咨询记录失败:\", error); // 打印错误日志方便排查\r\n    return { success: false, error: \"保存失败\" };\r\n  }\r\n}\r\n\r\n// ==========================================\r\n// 4. 心理测评系统 (TestResult)\r\n// ==========================================\r\n\r\n// [修改] 提交心理测评结果 (修复版：支持 SDS/SAS 标准分 + 防止重复报错)\r\n// [修改] 提交预约前测 (纯记录版：只存分，不报警，不触发危机干预)\r\nexport async function submitPsychTest(appointmentId: string, answers: any) {\r\n  try {\r\n    const { sds, sas, ses } = answers;\r\n\r\n    // 1. 计算原始分\r\n    const sdsRaw = (sds || []).reduce((a: number, b: number) => a + b, 0);\r\n    const sasRaw = (sas || []).reduce((a: number, b: number) => a + b, 0);\r\n    const sesScore = (ses || []).reduce((a: number, b: number) => a + b, 0);\r\n\r\n    // 2. 计算标准分 (仅做记录)\r\n    const sdsScore = Math.floor(sdsRaw * 1.25);\r\n    const sasScore = Math.floor(sasRaw * 1.25);\r\n\r\n    // 3. 这里的 isHighRisk 仅用于单次记录，不再联动系统报警\r\n    let isHighRisk = false;\r\n    let riskLevel = 'normal';\r\n\r\n    if (sdsScore >= 53 || sasScore >= 50) {\r\n        isHighRisk = true;\r\n        if (sdsScore >= 63 || sasScore >= 60) {\r\n            riskLevel = 'red';\r\n        } else {\r\n            riskLevel = 'yellow';\r\n        }\r\n    }\r\n\r\n    // 4. 保存结果到数据库 (Upsert防止重复报错)\r\n    await prisma.testResult.upsert({\r\n        where: {\r\n            appointmentId: appointmentId\r\n        },\r\n        create: {\r\n            appointmentId,\r\n            sdsScore,\r\n            sasScore,\r\n            sesScore,\r\n            rawAnswers: JSON.stringify(answers),\r\n            isHighRisk, // 存入数据库供咨询师查看，但不触发系统动作\r\n            riskLevel\r\n        },\r\n        update: {\r\n            sdsScore,\r\n            sasScore,\r\n            sesScore,\r\n            rawAnswers: JSON.stringify(answers),\r\n            isHighRisk,\r\n            riskLevel,\r\n            createdAt: new Date()\r\n        }\r\n    });\r\n\r\n    // ❌ 已删除：prisma.appointment.update (标记预约为危机) 的代码\r\n    // ❌ 已删除：prisma.user.update (标记学生为红名) 的代码\r\n    // ❌ 已删除：Crisis 相关的页面刷新\r\n\r\n    // 5. 仅刷新预约列表\r\n    revalidatePath('/student/booking');\r\n    revalidatePath('/counselor/cases');\r\n\r\n    // 返回成功，不再返回 isHighRisk 给前端弹窗\r\n    return { success: true };\r\n\r\n  } catch (error) {\r\n    console.error(\"提交测评失败:\", error);\r\n    return { success: false, msg: \"提交失败，请重试\" };\r\n  }\r\n}\r\n\r\n// ==========================================\r\n// 5. 排班系统 (Schedule)\r\n// ==========================================\r\n\r\nexport async function getCounselorSchedule(counselorId: string) {\r\n  try {\r\n    const schedules = await prisma.schedule.findMany({\r\n      where: { counselorId, isAvailable: true }\r\n    });\r\n    return { success: true, data: schedules };\r\n  } catch (error) {\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\nexport async function updateSchedule(counselorId: string, slots: any[]) {\r\n  try {\r\n    const ops = slots.map(slot => \r\n      prisma.schedule.upsert({\r\n        where: {\r\n          counselorId_dayOfWeek_timeSlot: {\r\n            counselorId,\r\n            dayOfWeek: slot.dayOfWeek,\r\n            timeSlot: slot.timeSlot\r\n          }\r\n        },\r\n        update: { isAvailable: slot.isAvailable },\r\n        create: {\r\n          counselorId,\r\n          dayOfWeek: slot.dayOfWeek,\r\n          timeSlot: slot.timeSlot,\r\n          isAvailable: slot.isAvailable\r\n        }\r\n      })\r\n    );\r\n    \r\n    await prisma.$transaction(ops);\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(error);\r\n    return { success: false, error: \"保存失败\" };\r\n  }\r\n}\r\n\r\n// ==========================================\r\n// 6. 聊天系统 (Messages)\r\n// ==========================================\r\n\r\nexport async function getChatContacts(currentUserId: string, role: string) {\r\n  try {\r\n    if (role === 'student') {\r\n      const counselors = await prisma.user.findMany({\r\n        where: { role: 'counselor' },\r\n        select: { id: true, name: true, avatar: true, college: true }\r\n      });\r\n      return { success: true, data: counselors };\r\n    } else {\r\n      const students = await prisma.user.findMany({\r\n        where: { role: 'student' },\r\n        select: { id: true, name: true, avatar: true, college: true }\r\n      });\r\n      return { success: true, data: students };\r\n    }\r\n  } catch (error) {\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\nexport async function getMessages(userId1: string, userId2: string) {\r\n  try {\r\n    const messages = await prisma.message.findMany({\r\n      where: {\r\n        OR: [\r\n          { senderId: userId1, receiverId: userId2 },\r\n          { senderId: userId2, receiverId: userId1 }\r\n        ]\r\n      },\r\n      orderBy: { createdAt: 'asc' },\r\n      include: {\r\n        sender: { select: { name: true, avatar: true } }\r\n      }\r\n    });\r\n    return { success: true, data: messages };\r\n  } catch (error) {\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\nexport async function sendMessage(senderId: string, receiverId: string, content: string) {\r\n  try {\r\n    const message = await prisma.message.create({\r\n      data: { senderId, receiverId, content }\r\n    });\r\n    return { success: true, data: message };\r\n  } catch (error) {\r\n    return { success: false, error: \"发送失败\" };\r\n  }\r\n}\r\n\r\n// ==========================================\r\n// 7. 文章系统 (Articles)\r\n// ==========================================\r\n\r\nexport async function getArticles() {\r\n  const articles = await prisma.article.findMany({\r\n    orderBy: { createdAt: 'desc' }\r\n  });\r\n  return articles.map(a => ({\r\n    ...a,\r\n    createdAt: a.createdAt.toISOString()\r\n  }));\r\n}\r\n\r\nexport async function getArticleById(id: string) {\r\n  try {\r\n    const article = await prisma.article.findUnique({ where: { id } });\r\n    if (article) return { success: true, data: article };\r\n    return { success: false, error: \"文章未找到\" };\r\n  } catch (error) {\r\n    return { success: false, error: \"查询失败\" };\r\n  }\r\n}\r\n\r\nexport async function createArticle(data: any) {\r\n  await prisma.article.create({\r\n    data: {\r\n      ...data,\r\n      author: '管理员',\r\n      views: 0,\r\n      image: \"https://images.unsplash.com/photo-1499209974431-2761eb43a768?w=800&q=80\"\r\n    }\r\n  });\r\n  revalidatePath(\"/student/articles\");\r\n  revalidatePath(\"/admin/content\");\r\n  return { success: true };\r\n}\r\n\r\nexport async function deleteArticle(id: string) {\r\n  try {\r\n    await prisma.article.delete({ where: { id } });\r\n    revalidatePath(\"/admin/content\");\r\n    revalidatePath(\"/student/articles\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"删除失败\" };\r\n  }\r\n}\r\n\r\n// ==========================================\r\n// 8. 系统管理与看板\r\n// ==========================================\r\n\r\nexport async function getAdminDashboardStats() {\r\n  try {\r\n    const [studentCount, appointmentCount, completedCount, rawChartData] = await Promise.all([\r\n      prisma.user.count({ where: { role: 'student' } }),\r\n      \r\n      // 统计所有预约 (包括等待中的，用于显示热度)\r\n      prisma.appointment.count(), \r\n\r\n      // 统计已完成\r\n      prisma.appointment.count({ where: { status: 'completed' } }),\r\n\r\n      // 图表数据 (统计最近7天)\r\n      prisma.appointment.findMany({\r\n        where: {\r\n          date: { gte: new Date(new Date().setDate(new Date().getDate() - 6)) }\r\n        },\r\n        select: { date: true }\r\n      })\r\n    ]);\r\n\r\n    const completionRate = appointmentCount > 0 \r\n      ? Math.round((completedCount / appointmentCount) * 100) + \"%\" \r\n      : \"0%\";\r\n\r\n    const chartData = [];\r\n    const weekMap = ['周日', '周一', '周二', '周三', '周四', '周五', '周六'];\r\n\r\n    for (let i = 6; i >= 0; i--) {\r\n      const d = new Date();\r\n      d.setDate(d.getDate() - i);\r\n      const month = d.getMonth() + 1;\r\n      const day = d.getDate();\r\n      const dateKey = `${month}/${day}`;\r\n      const weekLabel = weekMap[d.getDay()];\r\n\r\n      const count = rawChartData.filter(apt => {\r\n        const aptDate = new Date(apt.date);\r\n        return aptDate.getDate() === day && aptDate.getMonth() + 1 === month;\r\n      }).length;\r\n\r\n      chartData.push({ name: dateKey, day: weekLabel, visits: count });\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        stats: {\r\n          students: studentCount,\r\n          appointments: appointmentCount,\r\n          crisis: 0, // 暂无危机预警逻辑\r\n          rate: completionRate\r\n        },\r\n        chart: chartData\r\n      }\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error(\"看板数据加载失败:\", error);\r\n    return { success: false, error: \"加载失败\" };\r\n  }\r\n}\r\n\r\nexport async function getSystemSettings() {\r\n  try {\r\n    let config = await prisma.systemConfig.findFirst();\r\n    if (!config) {\r\n      config = await prisma.systemConfig.create({ data: {} });\r\n    }\r\n    return { success: true, data: config };\r\n  } catch (error) {\r\n    return { success: false, error: \"获取配置失败\" };\r\n  }\r\n}\r\n\r\nexport async function updateSystemSettings(data: any) {\r\n  try {\r\n    const first = await prisma.systemConfig.findFirst();\r\n    if (first) {\r\n      await prisma.systemConfig.update({\r\n        where: { id: first.id },\r\n        data: {\r\n          platformName: data.platformName,\r\n          hotline: data.hotline,\r\n          openHours: data.openHours,\r\n          maintenanceMode: data.maintenanceMode === 'true' || data.maintenanceMode === true\r\n        }\r\n      });\r\n      return { success: true };\r\n    }\r\n    return { success: false, error: \"未找到配置记录\" };\r\n  } catch (error) {\r\n    return { success: false, error: \"保存失败\" };\r\n  }\r\n}\r\n\r\n// 保存自助测评结果\r\n// [修改] 自助测评系统 - 保存结果并更新用户状态\r\nexport async function saveAssessment(studentId: string, score: number, result: string) {\r\n  try {\r\n    // 1. 保存测评记录\r\n    await prisma.assessment.create({\r\n      data: {\r\n        studentId,\r\n        type: 'PHQ-9',\r\n        score,\r\n        result\r\n      }\r\n    });\r\n\r\n    // 2. ✅ 新增：如果分数高，直接把用户标记为高风险\r\n    // 假设 > 10 分为黄色预警，> 15 分为红色危机\r\n    if (score > 10) {\r\n        const newLevel = score > 15 ? 'red' : 'yellow';\r\n        await prisma.user.update({\r\n            where: { id: studentId },\r\n            data: { riskLevel: newLevel }\r\n        });\r\n    }\r\n\r\n    revalidatePath(\"/student/assessment\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"保存测评失败:\", error);\r\n    return { success: false, error: \"保存失败\" };\r\n  }\r\n}\r\n\r\n// 获取历史测评记录 (用于画图)\r\nexport async function getAssessmentHistory(studentId: string) {\r\n  try {\r\n    const data = await prisma.assessment.findMany({\r\n      where: { studentId },\r\n      orderBy: { createdAt: 'asc' } // 按时间正序排列，方便图表显示趋势\r\n    });\r\n    return data;\r\n  } catch (error) {\r\n    console.error(\"获取历史失败:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\n\r\n// ==========================================\r\n// 11. 危机干预/主动提醒系统 (Intervention)\r\n// ==========================================\r\n\r\n// [咨询师端] 获取需要关注的高风险学生列表\r\n// [修改] 获取需要关注的高风险学生列表\r\nexport async function getRiskStudents() {\r\n  try {\r\n    // 步骤 1: 找出所有高分测评的 studentId (分数 > 10)\r\n    const highRiskAssessments = await prisma.assessment.findMany({\r\n        where: { score: { gt: 10 } },\r\n        select: { studentId: true },\r\n        distinct: ['studentId'] // 去重\r\n    });\r\n    const highRiskIds = highRiskAssessments.map(a => a.studentId);\r\n\r\n    // 步骤 2: 找出被标记为 red/yellow 的用户\r\n    // 步骤 3: 合并查询 - 只要满足其中一个条件就算高风险\r\n    const riskUsers = await prisma.user.findMany({\r\n      where: {\r\n        role: 'student',\r\n        OR: [\r\n            { riskLevel: { in: ['red', 'yellow'] } }, // 已经被标记的\r\n            { id: { in: highRiskIds } }               // 或者虽未标记但分高的\r\n        ]\r\n      },\r\n      include: {\r\n        // 查最近的干预记录\r\n        studentInterventions: {\r\n          orderBy: { createdAt: 'desc' },\r\n          take: 1\r\n        }\r\n      }\r\n    });\r\n    \r\n    // 步骤 4: 补全数据 (查最近一次分数)\r\n    const enrichedUsers = await Promise.all(riskUsers.map(async (u) => {\r\n      const lastTest = await prisma.assessment.findFirst({\r\n        where: { studentId: u.id },\r\n        orderBy: { createdAt: 'desc' }\r\n      });\r\n      return {\r\n        ...u,\r\n        lastScore: lastTest?.score || 0,\r\n        lastTestTime: lastTest?.createdAt,\r\n        latestIntervention: u.studentInterventions[0] || null\r\n      };\r\n    }));\r\n\r\n    // 最后再过滤一遍，确保只显示确实有风险的\r\n    return enrichedUsers.filter(u => u.lastScore > 10 || u.riskLevel === 'red' || u.riskLevel === 'yellow');\r\n\r\n  } catch (error) {\r\n    console.error(\"获取风险名单失败:\", error);\r\n    return [];\r\n  }\r\n}\r\n\r\n// [咨询师端] 发送提醒\r\nexport async function sendInterventionReminder(studentId: string, counselorId: string, message: string) {\r\n  try {\r\n    await prisma.intervention.create({\r\n      data: {\r\n        studentId,\r\n        counselorId,\r\n        message,\r\n        status: 'pending'\r\n      }\r\n    });\r\n    revalidatePath('/counselor/interventions');\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"发送失败\" };\r\n  }\r\n}\r\n\r\n// [学生端] 检查是否有未处理的提醒\r\nexport async function checkPendingInterventions(studentId: string) {\r\n  try {\r\n    const intervention = await prisma.intervention.findFirst({\r\n      where: {\r\n        studentId,\r\n        status: 'pending' // 只找未处理的\r\n      },\r\n      orderBy: { createdAt: 'desc' },\r\n      include: {\r\n        counselor: { select: { name: true, avatar: true } }\r\n      }\r\n    });\r\n    return intervention;\r\n  } catch (error) {\r\n    return null;\r\n  }\r\n}\r\n\r\n// [学生端] 响应提醒 (接受或拒绝)\r\nexport async function respondToIntervention(interventionId: string, response: 'accepted' | 'rejected') {\r\n  try {\r\n    await prisma.intervention.update({\r\n      where: { id: interventionId },\r\n      data: { status: response }\r\n    });\r\n    \r\n    if (response === 'accepted') {\r\n       // 如果接受，顺便可以在这里记录日志或者发通知\r\n    }\r\n    \r\n    revalidatePath('/student/dashboard'); // 刷新状态\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false };\r\n  }\r\n}\r\n\r\n// ==========================================\r\n// 12. 智能预约逻辑 (核心算法)\r\n// ==========================================\r\n\r\nexport async function getAvailableSlotsForDate(counselorId: string, dateStr: string) {\r\n  try {\r\n    const targetDate = new Date(dateStr);\r\n    \r\n    // 1. 获取“星期几” (注意：JS getDay() 是 0-6 (周日-周六)，我们需要转成 1-7 或者跟你数据库 Schedule 表保持一致)\r\n    // 假设数据库存的是：1=周一 ... 5=周五, 6=周六, 7=周日\r\n    let dayOfWeek = targetDate.getDay();\r\n    if (dayOfWeek === 0) dayOfWeek = 7; // 把周日从0变为7\r\n\r\n    // 2. 获取咨询师的【基准排班】(Base Schedule)\r\n    const baseSchedules = await prisma.schedule.findMany({\r\n      where: {\r\n        counselorId,\r\n        dayOfWeek,\r\n        isAvailable: true // 只找老师开放的时间\r\n      },\r\n      select: { timeSlot: true }\r\n    });\r\n\r\n    // 如果老师这天压根没排班，直接返回空\r\n    if (baseSchedules.length === 0) {\r\n      return { success: true, data: [] };\r\n    }\r\n\r\n    // 3. 获取该日【已被占用】的时段 (Appointments)\r\n    // 我们需要查询状态为 pending(待审核) 和 confirmed(已确认) 的，rejected(已拒绝) 的不占位\r\n    const startOfDay = new Date(dateStr); startOfDay.setHours(0, 0, 0, 0);\r\n    const endOfDay = new Date(dateStr); endOfDay.setHours(23, 59, 59, 999);\r\n\r\n    const bookedAppointments = await prisma.appointment.findMany({\r\n      where: {\r\n        counselorId,\r\n        date: {\r\n          gte: startOfDay,\r\n          lte: endOfDay\r\n        },\r\n        status: {\r\n          in: ['pending', 'confirmed'] // ⚠️ 关键：待审核和已确认都算占用，防止重复申请\r\n        }\r\n      },\r\n      select: { time: true }\r\n    });\r\n\r\n    // 提取已被占用的时间字符串数组\r\n    const bookedTimes = bookedAppointments.map(app => app.time);\r\n\r\n    // 4. 计算【逻辑可用】 = 基准排班 - 已被占用\r\n    let availableSlots = baseSchedules\r\n      .map(s => s.timeSlot)\r\n      .filter(slot => !bookedTimes.includes(slot));\r\n\r\n    // 5. 【时间过滤】：如果是“今天”，必须过滤掉已经过去的时间\r\n    const now = new Date();\r\n    const isToday = now.toDateString() === targetDate.toDateString();\r\n\r\n    if (isToday) {\r\n      // 获取当前时间 \"HH:mm\" 格式\r\n      const currentHour = now.getHours().toString().padStart(2, '0');\r\n      const currentMinute = now.getMinutes().toString().padStart(2, '0');\r\n      const currentTimeStr = `${currentHour}:${currentMinute}`;\r\n\r\n      // 过滤：只保留开始时间晚于当前时间的 slot\r\n      // 假设 slot 格式为 \"08:30 - 09:20\"，我们取前5位 \"08:30\" 进行比较\r\n      availableSlots = availableSlots.filter(slot => {\r\n        const startTime = slot.split(' - ')[0]; // 取出 \"08:30\"\r\n        return startTime > currentTimeStr; // 字符串比较 \"09:30\" > \"08:30\" 是有效的\r\n      });\r\n    }\r\n\r\n    return { success: true, data: availableSlots.sort() };\r\n\r\n  } catch (error) {\r\n    console.error(\"计算可用时间失败:\", error);\r\n    return { success: false, data: [] };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;IAuasB,yBAAA,WAAA,GAAA,IAAA,+OAAA,EAAA,8CAAA,oOAAA,EAAA,KAAA,GAAA,0OAAA,EAAA"}},
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///D:/%E8%BD%AF%E4%BB%B6%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%AE%9E%E9%AA%8C/my-counseling-app/app/admin/dashboard/page.tsx"],"sourcesContent":["\"use client\";\r\nimport { useEffect, useState } from 'react';\r\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\r\nimport { BarChart, Bar, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } from 'recharts';\r\nimport { Users, AlertTriangle, FileText, CheckCircle, Loader2 } from 'lucide-react';\r\n// ✅ 引入后端 Action\r\nimport { getAdminDashboardStats } from '@/app/actions';\r\n\r\nexport default function AdminDashboard() {\r\n  const [loading, setLoading] = useState(true);\r\n  \r\n  // 初始状态\r\n  const [stats, setStats] = useState({\r\n    students: 0,\r\n    appointments: 0,\r\n    crisis: 0,\r\n    rate: '0%'\r\n  });\r\n  \r\n  const [chartData, setChartData] = useState<any[]>([]);\r\n\r\n  // ✅ 加载真实数据\r\n  useEffect(() => {\r\n    async function loadData() {\r\n      const res = await getAdminDashboardStats();\r\n      if (res.success && res.data) {\r\n        setStats(res.data.stats);\r\n        setChartData(res.data.chart);\r\n      }\r\n      setLoading(false);\r\n    }\r\n    loadData();\r\n  }, []);\r\n\r\n  return (\r\n    <div className=\"space-y-8\">\r\n      <h1 className=\"text-2xl font-bold text-[#1e293b]\">数据看板 (实时)</h1>\r\n\r\n      {/* 统计卡片 */}\r\n      <div className=\"grid grid-cols-1 md:grid-cols-4 gap-6\">\r\n        {[\r\n          { title: '注册学生', value: stats.students, icon: Users, color: 'bg-blue-500' },\r\n          { title: '预约总量', value: stats.appointments, icon: FileText, color: 'bg-green-500' },\r\n          { title: '需关注测评', value: stats.crisis, icon: AlertTriangle, color: 'bg-red-500' },\r\n          { title: '个案结案率', value: stats.rate, icon: CheckCircle, color: 'bg-indigo-500' },\r\n        ].map((item, i) => (\r\n          <Card key={i} className=\"border-0 shadow-sm\">\r\n            <CardContent className=\"p-6 flex items-center justify-between\">\r\n              <div>\r\n                <p className=\"text-sm font-medium text-slate-500\">{item.title}</p>\r\n                <h3 className=\"text-3xl font-bold mt-2 text-[#1e293b]\">\r\n                  {loading ? <Loader2 className=\"w-6 h-6 animate-spin text-slate-300\" /> : item.value}\r\n                </h3>\r\n              </div>\r\n              <div className={`p-4 rounded-lg ${item.color} text-white bg-opacity-90`}>\r\n                <item.icon className=\"w-6 h-6\" />\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        ))}\r\n      </div>\r\n\r\n      {/* 图表区域 */}\r\n      <Card className=\"border-0 shadow-sm\">\r\n        <CardHeader>\r\n          <CardTitle>近七日预约趋势</CardTitle>\r\n        </CardHeader>\r\n        <CardContent className=\"h-[400px]\">\r\n          {loading ? (\r\n             <div className=\"h-full flex items-center justify-center text-slate-400\">\r\n               <Loader2 className=\"w-8 h-8 animate-spin mr-2\" /> 数据分析中...\r\n             </div>\r\n          ) : (\r\n            <ResponsiveContainer width=\"100%\" height=\"100%\">\r\n              <BarChart data={chartData}>\r\n                <CartesianGrid strokeDasharray=\"3 3\" vertical={false} stroke=\"#f1f5f9\" />\r\n                <XAxis \r\n                  dataKey=\"name\" \r\n                  axisLine={false} \r\n                  tickLine={false} \r\n                  tick={{fill: '#64748b', fontSize: 12}} \r\n                  dy={10}\r\n                />\r\n                <YAxis \r\n                  axisLine={false} \r\n                  tickLine={false} \r\n                  tick={{fill: '#64748b', fontSize: 12}} \r\n                />\r\n                <Tooltip \r\n                  cursor={{fill: '#f8fafc'}} \r\n                  contentStyle={{borderRadius: '8px', border: 'none', boxShadow: '0 4px 12px rgba(0,0,0,0.1)'}} \r\n                />\r\n                <Bar \r\n                  dataKey=\"visits\" \r\n                  name=\"预约人次\" \r\n                  fill=\"#5D9C59\" \r\n                  radius={[4, 4, 0, 0]} \r\n                  barSize={40} \r\n                  animationDuration={1000}\r\n                />\r\n              </BarChart>\r\n            </ResponsiveContainer>\r\n          )}\r\n        </CardContent>\r\n      </Card>\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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"}}]
}