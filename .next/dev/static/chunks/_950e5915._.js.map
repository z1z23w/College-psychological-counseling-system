{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 4, "column": 0}, "map": {"version":3,"sources":["file:///D:/%E8%BD%AF%E4%BB%B6%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%AE%9E%E9%AA%8C/my-counseling-app/components/ui/card.tsx"],"sourcesContent":["import * as React from \"react\"\n\nimport { cn } from \"@/lib/utils\"\n\nfunction Card({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card\"\n      className={cn(\n        \"bg-card text-card-foreground flex flex-col gap-6 rounded-xl border py-6 shadow-sm\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction CardHeader({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-header\"\n      className={cn(\n        \"@container/card-header grid auto-rows-min grid-rows-[auto_auto] items-start gap-2 px-6 has-data-[slot=card-action]:grid-cols-[1fr_auto] [.border-b]:pb-6\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction CardTitle({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-title\"\n      className={cn(\"leading-none font-semibold\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction CardDescription({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-description\"\n      className={cn(\"text-muted-foreground text-sm\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction CardAction({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-action\"\n      className={cn(\n        \"col-start-2 row-span-2 row-start-1 self-start justify-self-end\",\n        className\n      )}\n      {...props}\n    />\n  )\n}\n\nfunction CardContent({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-content\"\n      className={cn(\"px-6\", className)}\n      {...props}\n    />\n  )\n}\n\nfunction CardFooter({ className, ...props }: React.ComponentProps<\"div\">) {\n  return (\n    <div\n      data-slot=\"card-footer\"\n      className={cn(\"flex items-center px-6 [.border-t]:pt-6\", className)}\n      {...props}\n    />\n  )\n}\n\nexport {\n  Card,\n  CardHeader,\n  CardFooter,\n  CardTitle,\n  CardAction,\n  CardDescription,\n  CardContent,\n}\n"],"names":[],"mappings":";;;;;;;;;;;;;;;;;AAEA;;;AAEA,SAAS,KAAK,EAAE,SAAS,EAAE,GAAG,OAAoC;IAChE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EACX,qFACA;QAED,GAAG,KAAK;;;;;;AAGf;KAXS;AAaT,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EACX,4JACA;QAED,GAAG,KAAK;;;;;;AAGf;MAXS;AAaT,SAAS,UAAU,EAAE,SAAS,EAAE,GAAG,OAAoC;IACrE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EAAC,8BAA8B;QAC3C,GAAG,KAAK;;;;;;AAGf;MARS;AAUT,SAAS,gBAAgB,EAAE,SAAS,EAAE,GAAG,OAAoC;IAC3E,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EAAC,iCAAiC;QAC9C,GAAG,KAAK;;;;;;AAGf;MARS;AAUT,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EACX,kEACA;QAED,GAAG,KAAK;;;;;;AAGf;MAXS;AAaT,SAAS,YAAY,EAAE,SAAS,EAAE,GAAG,OAAoC;IACvE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EAAC,QAAQ;QACrB,GAAG,KAAK;;;;;;AAGf;MARS;AAUT,SAAS,WAAW,EAAE,SAAS,EAAE,GAAG,OAAoC;IACtE,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EAAC,2CAA2C;QACxD,GAAG,KAAK;;;;;;AAGf;MARS"}},
    {"offset": {"line": 124, "column": 0}, "map": {"version":3,"sources":["file:///D:/%E8%BD%AF%E4%BB%B6%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%AE%9E%E9%AA%8C/my-counseling-app/components/ui/badge.tsx"],"sourcesContent":["import * as React from \"react\"\nimport { Slot } from \"@radix-ui/react-slot\"\nimport { cva, type VariantProps } from \"class-variance-authority\"\n\nimport { cn } from \"@/lib/utils\"\n\nconst badgeVariants = cva(\n  \"inline-flex items-center justify-center rounded-full border px-2 py-0.5 text-xs font-medium w-fit whitespace-nowrap shrink-0 [&>svg]:size-3 gap-1 [&>svg]:pointer-events-none focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px] aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive transition-[color,box-shadow] overflow-hidden\",\n  {\n    variants: {\n      variant: {\n        default:\n          \"border-transparent bg-primary text-primary-foreground [a&]:hover:bg-primary/90\",\n        secondary:\n          \"border-transparent bg-secondary text-secondary-foreground [a&]:hover:bg-secondary/90\",\n        destructive:\n          \"border-transparent bg-destructive text-white [a&]:hover:bg-destructive/90 focus-visible:ring-destructive/20 dark:focus-visible:ring-destructive/40 dark:bg-destructive/60\",\n        outline:\n          \"text-foreground [a&]:hover:bg-accent [a&]:hover:text-accent-foreground\",\n      },\n    },\n    defaultVariants: {\n      variant: \"default\",\n    },\n  }\n)\n\nfunction Badge({\n  className,\n  variant,\n  asChild = false,\n  ...props\n}: React.ComponentProps<\"span\"> &\n  VariantProps<typeof badgeVariants> & { asChild?: boolean }) {\n  const Comp = asChild ? Slot : \"span\"\n\n  return (\n    <Comp\n      data-slot=\"badge\"\n      className={cn(badgeVariants({ variant }), className)}\n      {...props}\n    />\n  )\n}\n\nexport { Badge, badgeVariants }\n"],"names":[],"mappings":";;;;;;;AACA;AACA;AAEA;;;;;AAEA,MAAM,gBAAgB,IAAA,0KAAG,EACvB,oZACA;IACE,UAAU;QACR,SAAS;YACP,SACE;YACF,WACE;YACF,aACE;YACF,SACE;QACJ;IACF;IACA,iBAAiB;QACf,SAAS;IACX;AACF;AAGF,SAAS,MAAM,EACb,SAAS,EACT,OAAO,EACP,UAAU,KAAK,EACf,GAAG,OAEuD;IAC1D,MAAM,OAAO,UAAU,2KAAI,GAAG;IAE9B,qBACE,6LAAC;QACC,aAAU;QACV,WAAW,IAAA,qHAAE,EAAC,cAAc;YAAE;QAAQ,IAAI;QACzC,GAAG,KAAK;;;;;;AAGf;KAhBS"}},
    {"offset": {"line": 176, "column": 0}, "map": {"version":3,"sources":["file:///D:/%E8%BD%AF%E4%BB%B6%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%AE%9E%E9%AA%8C/my-counseling-app/app/actions.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { prisma } from \"@/lib/db\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\n// ==========================================\r\n// 1. ç”¨æˆ·ç®¡ç† (ç®¡ç†å‘˜ç”¨ - ä¹‹å‰ä¸¢å¤±çš„éƒ¨åˆ†)\r\n// ==========================================\r\n\r\nexport async function getUsers() {\r\n  try {\r\n    const users = await prisma.user.findMany({\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n    return { success: true, data: users };\r\n  } catch (error) {\r\n    console.error(\"è·å–ç”¨æˆ·å¤±è´¥:\", error);\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\nexport async function createUser(formData: FormData) {\r\n  const name = formData.get(\"name\") as string;\r\n  const username = formData.get(\"username\") as string;\r\n  const role = formData.get(\"role\") as string;\r\n  const college = formData.get(\"college\") as string;\r\n\r\n  try {\r\n    await prisma.user.create({\r\n      data: {\r\n        name,\r\n        username,\r\n        role,\r\n        college,\r\n        password: \"123456\", // é»˜è®¤å¯†ç \r\n        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`\r\n      },\r\n    });\r\n    revalidatePath(\"/admin/users\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"åˆ›å»ºå¤±è´¥ï¼Œå­¦å·å¯èƒ½å·²å­˜åœ¨\" };\r\n  }\r\n}\r\n\r\n// ==========================================\r\n// 2. è®¤è¯ä¸æŸ¥è¯¢ (é€šç”¨)\r\n// ==========================================\r\n\r\n// ç™»å½•éªŒè¯\r\nexport async function loginAction(username: string, role: string) {\r\n  try {\r\n    const user = await prisma.user.findFirst({\r\n      where: { username, role }\r\n    });\r\n    if (!user) return { success: false, error: \"ç”¨æˆ·ä¸å­˜åœ¨æˆ–è§’è‰²é”™è¯¯\" };\r\n    \r\n    // è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸å«å¯†ç ï¼‰\r\n    const { password, ...userInfo } = user;\r\n    return { success: true, data: userInfo };\r\n  } catch (error) {\r\n    return { success: false, error: \"æ•°æ®åº“è¿æ¥å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// è·å–æ‰€æœ‰å’¨è¯¢å¸ˆ\r\nexport async function getCounselors() {\r\n  return await prisma.user.findMany({\r\n    where: { role: 'counselor' }\r\n  });\r\n}\r\n\r\n// ==========================================\r\n// 3. é¢„çº¦ç³»ç»Ÿ (Appointments)\r\n// ==========================================\r\n\r\n// åˆ›å»ºé¢„çº¦\r\nexport async function createAppointment(studentId: string, counselorId: string, date: string, time: string) {\r\n  try {\r\n    await prisma.appointment.create({\r\n      data: {\r\n        studentId,\r\n        counselorId,\r\n        date: new Date(date),\r\n        time,\r\n        status: 'pending',\r\n        notes: 'å­¦ç”Ÿå‘èµ·é¢„çº¦'\r\n      }\r\n    });\r\n    revalidatePath(\"/student/booking\");\r\n    revalidatePath(\"/counselor/dashboard\");\r\n    return { success: true };\r\n  } catch (e) {\r\n    return { success: false, error: \"é¢„çº¦åˆ›å»ºå¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// è·å–é¢„çº¦åˆ—è¡¨\r\nexport async function getAppointments(userId: string, role: string) {\r\n  const whereCondition = role === 'student' ? { studentId: userId } : { counselorId: userId };\r\n  \r\n  const data = await prisma.appointment.findMany({\r\n    where: whereCondition,\r\n    include: {\r\n      student: { select: { name: true } },\r\n      counselor: { select: { name: true } }\r\n    },\r\n    orderBy: { createdAt: 'desc' }\r\n  });\r\n\r\n  return data.map(apt => ({\r\n    ...apt,\r\n    date: apt.date.toISOString(),\r\n    createdAt: apt.createdAt.toISOString()\r\n  }));\r\n}\r\n\r\n// æ›´æ–°é¢„çº¦çŠ¶æ€\r\nexport async function updateAppointmentStatus(id: string, status: string) {\r\n  await prisma.appointment.update({\r\n    where: { id },\r\n    data: { status }\r\n  });\r\n  revalidatePath(\"/counselor/dashboard\");\r\n  revalidatePath(\"/student/booking\");\r\n  return { success: true };\r\n}\r\n\r\n// ==========================================\r\n// 4. æ–‡ç« ç³»ç»Ÿ (Articles)\r\n// ==========================================\r\n\r\nexport async function getArticles() {\r\n  const articles = await prisma.article.findMany({\r\n    orderBy: { createdAt: 'desc' }\r\n  });\r\n  return articles.map(a => ({\r\n    ...a,\r\n    createdAt: a.createdAt.toISOString()\r\n  }));\r\n}\r\n\r\nexport async function createArticle(data: any) {\r\n  await prisma.article.create({\r\n    data: {\r\n      ...data,\r\n      author: 'ç®¡ç†å‘˜',\r\n      views: 0,\r\n      image: \"https://images.unsplash.com/photo-1499209974431-2761eb43a768?w=800&q=80\"\r\n    }\r\n  });\r\n  revalidatePath(\"/student/articles\");\r\n  return { success: true };\r\n}\r\n\r\n// ==========================================\r\n// 5. æµ‹è¯„ç³»ç»Ÿ (Assessments)\r\n// ==========================================\r\n\r\nexport async function saveAssessment(studentId: string, score: number, result: string) {\r\n  await prisma.assessment.create({\r\n    data: {\r\n      studentId,\r\n      type: 'PHQ-9',\r\n      score,\r\n      result\r\n    }\r\n  });\r\n  revalidatePath(\"/student/assessment\");\r\n  return { success: true };\r\n}\r\n\r\nexport async function getAssessmentHistory(studentId: string) {\r\n  const data = await prisma.assessment.findMany({\r\n    where: { studentId },\r\n    orderBy: { createdAt: 'asc' }\r\n  });\r\n  return data.map(a => ({\r\n    ...a,\r\n    createdAt: a.createdAt.toISOString()\r\n  }));\r\n}\r\n\r\nexport async function deleteArticle(id: string) {\r\n  try {\r\n    await prisma.article.delete({\r\n      where: { id }\r\n    });\r\n    revalidatePath(\"/admin/content\"); // åˆ·æ–°åå°åˆ—è¡¨\r\n    revalidatePath(\"/student/articles\"); // åˆ·æ–°å­¦ç”Ÿç«¯åˆ—è¡¨\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"åˆ é™¤å¤±è´¥\" };\r\n  }\r\n}\r\n\r\nexport async function updateConsultationRecord(id: string, notes: string) {\r\n  try {\r\n    await prisma.appointment.update({\r\n      where: { id },\r\n      data: { \r\n        notes, \r\n        status: 'completed' // ä¿å­˜åè‡ªåŠ¨æ ‡è®°ä¸ºâ€œå·²å®Œæˆ/å¾…å½’æ¡£â€\r\n      }\r\n    });\r\n    revalidatePath(\"/counselor/cases\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"æ›´æ–°è®°å½•å¤±è´¥:\", error);\r\n    return { success: false, error: \"ä¿å­˜å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// åˆ é™¤ç”¨æˆ·\r\nexport async function deleteUser(id: string) {\r\n  try {\r\n    await prisma.user.delete({\r\n      where: { id }\r\n    });\r\n    revalidatePath(\"/admin/users\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"åˆ é™¤å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// æ›´æ–°ç”¨æˆ·\r\nexport async function updateUser(id: string, formData: FormData) {\r\n  const name = formData.get(\"name\") as string;\r\n  const username = formData.get(\"username\") as string;\r\n  const role = formData.get(\"role\") as string;\r\n  const college = formData.get(\"college\") as string;\r\n\r\n  try {\r\n    await prisma.user.update({\r\n      where: { id },\r\n      data: {\r\n        name,\r\n        username,\r\n        role,\r\n        college,\r\n      },\r\n    });\r\n    revalidatePath(\"/admin/users\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"æ›´æ–°å¤±è´¥ï¼Œå­¦å·å¯èƒ½å†²çª\" };\r\n  }\r\n}\r\n\r\nexport async function getAdminDashboardStats() {\r\n  //noStore(); // ğŸˆ² ç¦ç”¨ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®å®æ—¶\r\n\r\n  try {\r\n    const [studentCount, appointmentCount, completedCount, rawChartData] = await Promise.all([\r\n      // 1. æ³¨å†Œå­¦ç”Ÿæ€»æ•°\r\n      prisma.user.count({ \r\n        where: { role: 'student' } \r\n      }),\r\n\r\n      // 2. æœ‰æ•ˆé¢„çº¦æ€»é‡ (å…³é”®ä¿®æ”¹ï¼ï¼ï¼)\r\n      // ä»¥å‰ç»Ÿè®¡äº† pendingï¼Œç°åœ¨æˆ‘ä»¬åªç»Ÿè®¡ 'confirmed' å’Œ 'completed'\r\n      // è¿™æ ·ï¼šå­¦ç”Ÿåˆšç”³è¯·æ—¶(pending)ä¸å æ•°ï¼Œè€å¸ˆç‚¹äº†åŒæ„(confirmed)æ•°å­—æ‰ä¼š +1\r\n      prisma.appointment.count({\r\n        where: {\r\n          status: {\r\n            in: ['confirmed', 'completed'] // âœ… åªç®—â€œå·²ç¡®è®¤â€å’Œâ€œå·²å®Œæˆâ€çš„\r\n          }\r\n        }\r\n      }),\r\n\r\n      // 3. å·²å®Œæˆé¢„çº¦\r\n      prisma.appointment.count({ \r\n        where: { status: 'completed' } \r\n      }),\r\n\r\n      // 4. å›¾è¡¨æ•°æ®æº (åŒæ ·åªç»Ÿè®¡æœ‰æ•ˆçš„)\r\n      prisma.appointment.findMany({\r\n        where: {\r\n          date: {\r\n            gte: new Date(new Date().setDate(new Date().getDate() - 6))\r\n          },\r\n          status: {\r\n            in: ['confirmed', 'completed'] // âœ… å›¾è¡¨ä¹Ÿåªæ˜¾ç¤ºè€å¸ˆæ¥å•åçš„\r\n          }\r\n        },\r\n        select: { date: true }\r\n      })\r\n    ]);\r\n\r\n    // å±æœºå¹²é¢„ç»Ÿè®¡ (é¢„ç•™)\r\n    let crisisCount = 0;\r\n\r\n    // è®¡ç®—ç»“æ¡ˆç‡\r\n    const completionRate = appointmentCount > 0 \r\n      ? Math.round((completedCount / appointmentCount) * 100) + \"%\" \r\n      : \"0%\";\r\n\r\n    // ç”Ÿæˆå›¾è¡¨æ•°æ®\r\n    const chartData = [];\r\n    const weekMap = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];\r\n\r\n    for (let i = 6; i >= 0; i--) {\r\n      const d = new Date();\r\n      d.setDate(d.getDate() - i);\r\n      const month = d.getMonth() + 1;\r\n      const day = d.getDate();\r\n      const dateKey = `${month}/${day}`;\r\n      const weekLabel = weekMap[d.getDay()];\r\n\r\n      const count = rawChartData.filter(apt => {\r\n        const aptDate = new Date(apt.date);\r\n        return aptDate.getDate() === day && aptDate.getMonth() + 1 === month;\r\n      }).length;\r\n\r\n      chartData.push({ \r\n        name: dateKey, \r\n        day: weekLabel, \r\n        visits: count \r\n      });\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        stats: {\r\n          students: studentCount,\r\n          appointments: appointmentCount, // è¿™é‡Œç°åœ¨æ˜¾ç¤ºçš„æ˜¯â€œç”Ÿæ•ˆé¢„çº¦æ•°â€\r\n          crisis: crisisCount,\r\n          rate: completionRate\r\n        },\r\n        chart: chartData\r\n      }\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error(\"è·å–çœ‹æ¿æ•°æ®å¤±è´¥:\", error);\r\n    return { success: false, error: \"åŠ è½½å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// è·å–ç³»ç»Ÿé…ç½® (å¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºé»˜è®¤)\r\nexport async function getSystemSettings() {\r\n  try {\r\n    let config = await prisma.systemConfig.findFirst();\r\n    if (!config) {\r\n      config = await prisma.systemConfig.create({\r\n        data: {} // ä½¿ç”¨é»˜è®¤å€¼åˆ›å»º\r\n      });\r\n    }\r\n    return { success: true, data: config };\r\n  } catch (error) {\r\n    return { success: false, error: \"è·å–é…ç½®å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// æ›´æ–°ç³»ç»Ÿé…ç½®\r\nexport async function updateSystemSettings(data: any) {\r\n  try {\r\n    // å…ˆæ‰¾åˆ°ç¬¬ä¸€æ¡è®°å½•çš„ ID\r\n    const first = await prisma.systemConfig.findFirst();\r\n    \r\n    if (first) {\r\n      await prisma.systemConfig.update({\r\n        where: { id: first.id },\r\n        data: {\r\n          platformName: data.platformName,\r\n          hotline: data.hotline,\r\n          openHours: data.openHours,\r\n          maintenanceMode: data.maintenanceMode === 'true' || data.maintenanceMode === true\r\n        }\r\n      });\r\n      return { success: true };\r\n    }\r\n    return { success: false, error: \"æœªæ‰¾åˆ°é…ç½®è®°å½•\" };\r\n  } catch (error) {\r\n    console.error(error);\r\n    return { success: false, error: \"ä¿å­˜å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// 1. è·å–èŠå¤©è”ç³»äººåˆ—è¡¨\r\nexport async function getChatContacts(currentUserId: string, role: string) {\r\n  try {\r\n    if (role === 'student') {\r\n      // å¦‚æœæ˜¯å­¦ç”Ÿï¼Œè¿”å›æ‰€æœ‰å’¨è¯¢å¸ˆ\r\n      const counselors = await prisma.user.findMany({\r\n        where: { role: 'counselor' },\r\n        select: { id: true, name: true, avatar: true, college: true }\r\n      });\r\n      return { success: true, data: counselors };\r\n    } else {\r\n      // å¦‚æœæ˜¯å’¨è¯¢å¸ˆï¼Œè¿”å›ç»™å‘è¿‡æ¶ˆæ¯çš„å­¦ç”Ÿï¼ˆè¿™é‡Œç®€åŒ–é€»è¾‘ï¼šè¿”å›æ‰€æœ‰å­¦ç”Ÿï¼Œæˆ–è€…ä½ å¯ä»¥åšæ›´å¤æ‚çš„æŸ¥è¯¢ï¼‰\r\n      // ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬æš‚æ—¶è¿”å›æ‰€æœ‰å­¦ç”Ÿï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥åªè¿”å›æœ‰é¢„çº¦æˆ–èŠè¿‡çš„\r\n      const students = await prisma.user.findMany({\r\n        where: { role: 'student' },\r\n        select: { id: true, name: true, avatar: true, college: true }\r\n      });\r\n      return { success: true, data: students };\r\n    }\r\n  } catch (error) {\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\n// 2. è·å–æˆ‘å’ŒæŸäººçš„èŠå¤©è®°å½•\r\nexport async function getMessages(userId1: string, userId2: string) {\r\n  try {\r\n    const messages = await prisma.message.findMany({\r\n      where: {\r\n        OR: [\r\n          { senderId: userId1, receiverId: userId2 },\r\n          { senderId: userId2, receiverId: userId1 }\r\n        ]\r\n      },\r\n      orderBy: { createdAt: 'asc' }, // æŒ‰æ—¶é—´æ­£åºæ’åˆ—\r\n      include: {\r\n        sender: { select: { name: true, avatar: true } }\r\n      }\r\n    });\r\n    return { success: true, data: messages };\r\n  } catch (error) {\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\n// 3. å‘é€æ¶ˆæ¯\r\nexport async function sendMessage(senderId: string, receiverId: string, content: string) {\r\n  try {\r\n    const message = await prisma.message.create({\r\n      data: {\r\n        senderId,\r\n        receiverId,\r\n        content\r\n      }\r\n    });\r\n    // æ³¨æ„ï¼šèŠå¤©é€šå¸¸ä¸éœ€è¦ revalidatePathï¼Œå› ä¸ºæ˜¯å³æ—¶æ›´æ–°çŠ¶æ€\r\n    return { success: true, data: message };\r\n  } catch (error) {\r\n    return { success: false, error: \"å‘é€å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// 1. è·å–æŸä½å’¨è¯¢å¸ˆçš„æ’ç­\r\nexport async function getCounselorSchedule(counselorId: string) {\r\n  try {\r\n    const schedules = await prisma.schedule.findMany({\r\n      where: { counselorId, isAvailable: true }\r\n    });\r\n    return { success: true, data: schedules };\r\n  } catch (error) {\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\n// 2. æ‰¹é‡æ›´æ–°æ’ç­ (å’¨è¯¢å¸ˆç«¯ä½¿ç”¨)\r\n// slots æ ¼å¼ï¼š[{ dayOfWeek: 1, timeSlot: \"08:30 - 09:20\", isAvailable: true }, ...]\r\nexport async function updateSchedule(counselorId: string, slots: any[]) {\r\n  try {\r\n    // ä½¿ç”¨äº‹åŠ¡ï¼Œå…ˆåˆ ååŠ ï¼Œæˆ–è€…é€ä¸ª upsert\r\n    // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨ transaction é€ä¸ª upsert\r\n    const ops = slots.map(slot => \r\n      prisma.schedule.upsert({\r\n        where: {\r\n          counselorId_dayOfWeek_timeSlot: {\r\n            counselorId,\r\n            dayOfWeek: slot.dayOfWeek,\r\n            timeSlot: slot.timeSlot\r\n          }\r\n        },\r\n        update: { isAvailable: slot.isAvailable },\r\n        create: {\r\n          counselorId,\r\n          dayOfWeek: slot.dayOfWeek,\r\n          timeSlot: slot.timeSlot,\r\n          isAvailable: slot.isAvailable\r\n        }\r\n      })\r\n    );\r\n    \r\n    await prisma.$transaction(ops);\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(error);\r\n    return { success: false, error: \"ä¿å­˜å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// æ ¹æ® ID è·å–å•ç¯‡æ–‡ç« è¯¦æƒ…\r\nexport async function getArticleById(id: string) {\r\n  try {\r\n    const article = await prisma.article.findUnique({\r\n      where: { id: id }\r\n    });\r\n    \r\n    if (article) {\r\n      return { success: true, data: article };\r\n    }\r\n    return { success: false, error: \"æ–‡ç« æœªæ‰¾åˆ°\" };\r\n  } catch (error) {\r\n    console.error(error);\r\n    return { success: false, error: \"æŸ¥è¯¢å¤±è´¥\" };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;IAkGsB,kBAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA"}},
    {"offset": {"line": 191, "column": 0}, "map": {"version":3,"sources":["file:///D:/%E8%BD%AF%E4%BB%B6%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%AE%9E%E9%AA%8C/my-counseling-app/app/actions.ts"],"sourcesContent":["\"use server\";\r\n\r\nimport { prisma } from \"@/lib/db\";\r\nimport { revalidatePath } from \"next/cache\";\r\n\r\n// ==========================================\r\n// 1. ç”¨æˆ·ç®¡ç† (ç®¡ç†å‘˜ç”¨ - ä¹‹å‰ä¸¢å¤±çš„éƒ¨åˆ†)\r\n// ==========================================\r\n\r\nexport async function getUsers() {\r\n  try {\r\n    const users = await prisma.user.findMany({\r\n      orderBy: { createdAt: 'desc' }\r\n    });\r\n    return { success: true, data: users };\r\n  } catch (error) {\r\n    console.error(\"è·å–ç”¨æˆ·å¤±è´¥:\", error);\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\nexport async function createUser(formData: FormData) {\r\n  const name = formData.get(\"name\") as string;\r\n  const username = formData.get(\"username\") as string;\r\n  const role = formData.get(\"role\") as string;\r\n  const college = formData.get(\"college\") as string;\r\n\r\n  try {\r\n    await prisma.user.create({\r\n      data: {\r\n        name,\r\n        username,\r\n        role,\r\n        college,\r\n        password: \"123456\", // é»˜è®¤å¯†ç \r\n        avatar: `https://api.dicebear.com/7.x/avataaars/svg?seed=${name}`\r\n      },\r\n    });\r\n    revalidatePath(\"/admin/users\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"åˆ›å»ºå¤±è´¥ï¼Œå­¦å·å¯èƒ½å·²å­˜åœ¨\" };\r\n  }\r\n}\r\n\r\n// ==========================================\r\n// 2. è®¤è¯ä¸æŸ¥è¯¢ (é€šç”¨)\r\n// ==========================================\r\n\r\n// ç™»å½•éªŒè¯\r\nexport async function loginAction(username: string, role: string) {\r\n  try {\r\n    const user = await prisma.user.findFirst({\r\n      where: { username, role }\r\n    });\r\n    if (!user) return { success: false, error: \"ç”¨æˆ·ä¸å­˜åœ¨æˆ–è§’è‰²é”™è¯¯\" };\r\n    \r\n    // è¿”å›ç”¨æˆ·ä¿¡æ¯ï¼ˆä¸å«å¯†ç ï¼‰\r\n    const { password, ...userInfo } = user;\r\n    return { success: true, data: userInfo };\r\n  } catch (error) {\r\n    return { success: false, error: \"æ•°æ®åº“è¿æ¥å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// è·å–æ‰€æœ‰å’¨è¯¢å¸ˆ\r\nexport async function getCounselors() {\r\n  return await prisma.user.findMany({\r\n    where: { role: 'counselor' }\r\n  });\r\n}\r\n\r\n// ==========================================\r\n// 3. é¢„çº¦ç³»ç»Ÿ (Appointments)\r\n// ==========================================\r\n\r\n// åˆ›å»ºé¢„çº¦\r\nexport async function createAppointment(studentId: string, counselorId: string, date: string, time: string) {\r\n  try {\r\n    await prisma.appointment.create({\r\n      data: {\r\n        studentId,\r\n        counselorId,\r\n        date: new Date(date),\r\n        time,\r\n        status: 'pending',\r\n        notes: 'å­¦ç”Ÿå‘èµ·é¢„çº¦'\r\n      }\r\n    });\r\n    revalidatePath(\"/student/booking\");\r\n    revalidatePath(\"/counselor/dashboard\");\r\n    return { success: true };\r\n  } catch (e) {\r\n    return { success: false, error: \"é¢„çº¦åˆ›å»ºå¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// è·å–é¢„çº¦åˆ—è¡¨\r\nexport async function getAppointments(userId: string, role: string) {\r\n  const whereCondition = role === 'student' ? { studentId: userId } : { counselorId: userId };\r\n  \r\n  const data = await prisma.appointment.findMany({\r\n    where: whereCondition,\r\n    include: {\r\n      student: { select: { name: true } },\r\n      counselor: { select: { name: true } }\r\n    },\r\n    orderBy: { createdAt: 'desc' }\r\n  });\r\n\r\n  return data.map(apt => ({\r\n    ...apt,\r\n    date: apt.date.toISOString(),\r\n    createdAt: apt.createdAt.toISOString()\r\n  }));\r\n}\r\n\r\n// æ›´æ–°é¢„çº¦çŠ¶æ€\r\nexport async function updateAppointmentStatus(id: string, status: string) {\r\n  await prisma.appointment.update({\r\n    where: { id },\r\n    data: { status }\r\n  });\r\n  revalidatePath(\"/counselor/dashboard\");\r\n  revalidatePath(\"/student/booking\");\r\n  return { success: true };\r\n}\r\n\r\n// ==========================================\r\n// 4. æ–‡ç« ç³»ç»Ÿ (Articles)\r\n// ==========================================\r\n\r\nexport async function getArticles() {\r\n  const articles = await prisma.article.findMany({\r\n    orderBy: { createdAt: 'desc' }\r\n  });\r\n  return articles.map(a => ({\r\n    ...a,\r\n    createdAt: a.createdAt.toISOString()\r\n  }));\r\n}\r\n\r\nexport async function createArticle(data: any) {\r\n  await prisma.article.create({\r\n    data: {\r\n      ...data,\r\n      author: 'ç®¡ç†å‘˜',\r\n      views: 0,\r\n      image: \"https://images.unsplash.com/photo-1499209974431-2761eb43a768?w=800&q=80\"\r\n    }\r\n  });\r\n  revalidatePath(\"/student/articles\");\r\n  return { success: true };\r\n}\r\n\r\n// ==========================================\r\n// 5. æµ‹è¯„ç³»ç»Ÿ (Assessments)\r\n// ==========================================\r\n\r\nexport async function saveAssessment(studentId: string, score: number, result: string) {\r\n  await prisma.assessment.create({\r\n    data: {\r\n      studentId,\r\n      type: 'PHQ-9',\r\n      score,\r\n      result\r\n    }\r\n  });\r\n  revalidatePath(\"/student/assessment\");\r\n  return { success: true };\r\n}\r\n\r\nexport async function getAssessmentHistory(studentId: string) {\r\n  const data = await prisma.assessment.findMany({\r\n    where: { studentId },\r\n    orderBy: { createdAt: 'asc' }\r\n  });\r\n  return data.map(a => ({\r\n    ...a,\r\n    createdAt: a.createdAt.toISOString()\r\n  }));\r\n}\r\n\r\nexport async function deleteArticle(id: string) {\r\n  try {\r\n    await prisma.article.delete({\r\n      where: { id }\r\n    });\r\n    revalidatePath(\"/admin/content\"); // åˆ·æ–°åå°åˆ—è¡¨\r\n    revalidatePath(\"/student/articles\"); // åˆ·æ–°å­¦ç”Ÿç«¯åˆ—è¡¨\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"åˆ é™¤å¤±è´¥\" };\r\n  }\r\n}\r\n\r\nexport async function updateConsultationRecord(id: string, notes: string) {\r\n  try {\r\n    await prisma.appointment.update({\r\n      where: { id },\r\n      data: { \r\n        notes, \r\n        status: 'completed' // ä¿å­˜åè‡ªåŠ¨æ ‡è®°ä¸ºâ€œå·²å®Œæˆ/å¾…å½’æ¡£â€\r\n      }\r\n    });\r\n    revalidatePath(\"/counselor/cases\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(\"æ›´æ–°è®°å½•å¤±è´¥:\", error);\r\n    return { success: false, error: \"ä¿å­˜å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// åˆ é™¤ç”¨æˆ·\r\nexport async function deleteUser(id: string) {\r\n  try {\r\n    await prisma.user.delete({\r\n      where: { id }\r\n    });\r\n    revalidatePath(\"/admin/users\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"åˆ é™¤å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// æ›´æ–°ç”¨æˆ·\r\nexport async function updateUser(id: string, formData: FormData) {\r\n  const name = formData.get(\"name\") as string;\r\n  const username = formData.get(\"username\") as string;\r\n  const role = formData.get(\"role\") as string;\r\n  const college = formData.get(\"college\") as string;\r\n\r\n  try {\r\n    await prisma.user.update({\r\n      where: { id },\r\n      data: {\r\n        name,\r\n        username,\r\n        role,\r\n        college,\r\n      },\r\n    });\r\n    revalidatePath(\"/admin/users\");\r\n    return { success: true };\r\n  } catch (error) {\r\n    return { success: false, error: \"æ›´æ–°å¤±è´¥ï¼Œå­¦å·å¯èƒ½å†²çª\" };\r\n  }\r\n}\r\n\r\nexport async function getAdminDashboardStats() {\r\n  //noStore(); // ğŸˆ² ç¦ç”¨ç¼“å­˜ï¼Œç¡®ä¿æ•°æ®å®æ—¶\r\n\r\n  try {\r\n    const [studentCount, appointmentCount, completedCount, rawChartData] = await Promise.all([\r\n      // 1. æ³¨å†Œå­¦ç”Ÿæ€»æ•°\r\n      prisma.user.count({ \r\n        where: { role: 'student' } \r\n      }),\r\n\r\n      // 2. æœ‰æ•ˆé¢„çº¦æ€»é‡ (å…³é”®ä¿®æ”¹ï¼ï¼ï¼)\r\n      // ä»¥å‰ç»Ÿè®¡äº† pendingï¼Œç°åœ¨æˆ‘ä»¬åªç»Ÿè®¡ 'confirmed' å’Œ 'completed'\r\n      // è¿™æ ·ï¼šå­¦ç”Ÿåˆšç”³è¯·æ—¶(pending)ä¸å æ•°ï¼Œè€å¸ˆç‚¹äº†åŒæ„(confirmed)æ•°å­—æ‰ä¼š +1\r\n      prisma.appointment.count({\r\n        where: {\r\n          status: {\r\n            in: ['confirmed', 'completed'] // âœ… åªç®—â€œå·²ç¡®è®¤â€å’Œâ€œå·²å®Œæˆâ€çš„\r\n          }\r\n        }\r\n      }),\r\n\r\n      // 3. å·²å®Œæˆé¢„çº¦\r\n      prisma.appointment.count({ \r\n        where: { status: 'completed' } \r\n      }),\r\n\r\n      // 4. å›¾è¡¨æ•°æ®æº (åŒæ ·åªç»Ÿè®¡æœ‰æ•ˆçš„)\r\n      prisma.appointment.findMany({\r\n        where: {\r\n          date: {\r\n            gte: new Date(new Date().setDate(new Date().getDate() - 6))\r\n          },\r\n          status: {\r\n            in: ['confirmed', 'completed'] // âœ… å›¾è¡¨ä¹Ÿåªæ˜¾ç¤ºè€å¸ˆæ¥å•åçš„\r\n          }\r\n        },\r\n        select: { date: true }\r\n      })\r\n    ]);\r\n\r\n    // å±æœºå¹²é¢„ç»Ÿè®¡ (é¢„ç•™)\r\n    let crisisCount = 0;\r\n\r\n    // è®¡ç®—ç»“æ¡ˆç‡\r\n    const completionRate = appointmentCount > 0 \r\n      ? Math.round((completedCount / appointmentCount) * 100) + \"%\" \r\n      : \"0%\";\r\n\r\n    // ç”Ÿæˆå›¾è¡¨æ•°æ®\r\n    const chartData = [];\r\n    const weekMap = ['å‘¨æ—¥', 'å‘¨ä¸€', 'å‘¨äºŒ', 'å‘¨ä¸‰', 'å‘¨å››', 'å‘¨äº”', 'å‘¨å…­'];\r\n\r\n    for (let i = 6; i >= 0; i--) {\r\n      const d = new Date();\r\n      d.setDate(d.getDate() - i);\r\n      const month = d.getMonth() + 1;\r\n      const day = d.getDate();\r\n      const dateKey = `${month}/${day}`;\r\n      const weekLabel = weekMap[d.getDay()];\r\n\r\n      const count = rawChartData.filter(apt => {\r\n        const aptDate = new Date(apt.date);\r\n        return aptDate.getDate() === day && aptDate.getMonth() + 1 === month;\r\n      }).length;\r\n\r\n      chartData.push({ \r\n        name: dateKey, \r\n        day: weekLabel, \r\n        visits: count \r\n      });\r\n    }\r\n\r\n    return {\r\n      success: true,\r\n      data: {\r\n        stats: {\r\n          students: studentCount,\r\n          appointments: appointmentCount, // è¿™é‡Œç°åœ¨æ˜¾ç¤ºçš„æ˜¯â€œç”Ÿæ•ˆé¢„çº¦æ•°â€\r\n          crisis: crisisCount,\r\n          rate: completionRate\r\n        },\r\n        chart: chartData\r\n      }\r\n    };\r\n\r\n  } catch (error) {\r\n    console.error(\"è·å–çœ‹æ¿æ•°æ®å¤±è´¥:\", error);\r\n    return { success: false, error: \"åŠ è½½å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// è·å–ç³»ç»Ÿé…ç½® (å¦‚æœæ²¡æœ‰åˆ™åˆ›å»ºé»˜è®¤)\r\nexport async function getSystemSettings() {\r\n  try {\r\n    let config = await prisma.systemConfig.findFirst();\r\n    if (!config) {\r\n      config = await prisma.systemConfig.create({\r\n        data: {} // ä½¿ç”¨é»˜è®¤å€¼åˆ›å»º\r\n      });\r\n    }\r\n    return { success: true, data: config };\r\n  } catch (error) {\r\n    return { success: false, error: \"è·å–é…ç½®å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// æ›´æ–°ç³»ç»Ÿé…ç½®\r\nexport async function updateSystemSettings(data: any) {\r\n  try {\r\n    // å…ˆæ‰¾åˆ°ç¬¬ä¸€æ¡è®°å½•çš„ ID\r\n    const first = await prisma.systemConfig.findFirst();\r\n    \r\n    if (first) {\r\n      await prisma.systemConfig.update({\r\n        where: { id: first.id },\r\n        data: {\r\n          platformName: data.platformName,\r\n          hotline: data.hotline,\r\n          openHours: data.openHours,\r\n          maintenanceMode: data.maintenanceMode === 'true' || data.maintenanceMode === true\r\n        }\r\n      });\r\n      return { success: true };\r\n    }\r\n    return { success: false, error: \"æœªæ‰¾åˆ°é…ç½®è®°å½•\" };\r\n  } catch (error) {\r\n    console.error(error);\r\n    return { success: false, error: \"ä¿å­˜å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// 1. è·å–èŠå¤©è”ç³»äººåˆ—è¡¨\r\nexport async function getChatContacts(currentUserId: string, role: string) {\r\n  try {\r\n    if (role === 'student') {\r\n      // å¦‚æœæ˜¯å­¦ç”Ÿï¼Œè¿”å›æ‰€æœ‰å’¨è¯¢å¸ˆ\r\n      const counselors = await prisma.user.findMany({\r\n        where: { role: 'counselor' },\r\n        select: { id: true, name: true, avatar: true, college: true }\r\n      });\r\n      return { success: true, data: counselors };\r\n    } else {\r\n      // å¦‚æœæ˜¯å’¨è¯¢å¸ˆï¼Œè¿”å›ç»™å‘è¿‡æ¶ˆæ¯çš„å­¦ç”Ÿï¼ˆè¿™é‡Œç®€åŒ–é€»è¾‘ï¼šè¿”å›æ‰€æœ‰å­¦ç”Ÿï¼Œæˆ–è€…ä½ å¯ä»¥åšæ›´å¤æ‚çš„æŸ¥è¯¢ï¼‰\r\n      // ä¸ºäº†æ¼”ç¤ºæ–¹ä¾¿ï¼Œæˆ‘ä»¬æš‚æ—¶è¿”å›æ‰€æœ‰å­¦ç”Ÿï¼Œå®é™…é¡¹ç›®ä¸­åº”è¯¥åªè¿”å›æœ‰é¢„çº¦æˆ–èŠè¿‡çš„\r\n      const students = await prisma.user.findMany({\r\n        where: { role: 'student' },\r\n        select: { id: true, name: true, avatar: true, college: true }\r\n      });\r\n      return { success: true, data: students };\r\n    }\r\n  } catch (error) {\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\n// 2. è·å–æˆ‘å’ŒæŸäººçš„èŠå¤©è®°å½•\r\nexport async function getMessages(userId1: string, userId2: string) {\r\n  try {\r\n    const messages = await prisma.message.findMany({\r\n      where: {\r\n        OR: [\r\n          { senderId: userId1, receiverId: userId2 },\r\n          { senderId: userId2, receiverId: userId1 }\r\n        ]\r\n      },\r\n      orderBy: { createdAt: 'asc' }, // æŒ‰æ—¶é—´æ­£åºæ’åˆ—\r\n      include: {\r\n        sender: { select: { name: true, avatar: true } }\r\n      }\r\n    });\r\n    return { success: true, data: messages };\r\n  } catch (error) {\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\n// 3. å‘é€æ¶ˆæ¯\r\nexport async function sendMessage(senderId: string, receiverId: string, content: string) {\r\n  try {\r\n    const message = await prisma.message.create({\r\n      data: {\r\n        senderId,\r\n        receiverId,\r\n        content\r\n      }\r\n    });\r\n    // æ³¨æ„ï¼šèŠå¤©é€šå¸¸ä¸éœ€è¦ revalidatePathï¼Œå› ä¸ºæ˜¯å³æ—¶æ›´æ–°çŠ¶æ€\r\n    return { success: true, data: message };\r\n  } catch (error) {\r\n    return { success: false, error: \"å‘é€å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// 1. è·å–æŸä½å’¨è¯¢å¸ˆçš„æ’ç­\r\nexport async function getCounselorSchedule(counselorId: string) {\r\n  try {\r\n    const schedules = await prisma.schedule.findMany({\r\n      where: { counselorId, isAvailable: true }\r\n    });\r\n    return { success: true, data: schedules };\r\n  } catch (error) {\r\n    return { success: false, data: [] };\r\n  }\r\n}\r\n\r\n// 2. æ‰¹é‡æ›´æ–°æ’ç­ (å’¨è¯¢å¸ˆç«¯ä½¿ç”¨)\r\n// slots æ ¼å¼ï¼š[{ dayOfWeek: 1, timeSlot: \"08:30 - 09:20\", isAvailable: true }, ...]\r\nexport async function updateSchedule(counselorId: string, slots: any[]) {\r\n  try {\r\n    // ä½¿ç”¨äº‹åŠ¡ï¼Œå…ˆåˆ ååŠ ï¼Œæˆ–è€…é€ä¸ª upsert\r\n    // ç®€å•èµ·è§ï¼Œæˆ‘ä»¬ä½¿ç”¨ transaction é€ä¸ª upsert\r\n    const ops = slots.map(slot => \r\n      prisma.schedule.upsert({\r\n        where: {\r\n          counselorId_dayOfWeek_timeSlot: {\r\n            counselorId,\r\n            dayOfWeek: slot.dayOfWeek,\r\n            timeSlot: slot.timeSlot\r\n          }\r\n        },\r\n        update: { isAvailable: slot.isAvailable },\r\n        create: {\r\n          counselorId,\r\n          dayOfWeek: slot.dayOfWeek,\r\n          timeSlot: slot.timeSlot,\r\n          isAvailable: slot.isAvailable\r\n        }\r\n      })\r\n    );\r\n    \r\n    await prisma.$transaction(ops);\r\n    return { success: true };\r\n  } catch (error) {\r\n    console.error(error);\r\n    return { success: false, error: \"ä¿å­˜å¤±è´¥\" };\r\n  }\r\n}\r\n\r\n// æ ¹æ® ID è·å–å•ç¯‡æ–‡ç« è¯¦æƒ…\r\nexport async function getArticleById(id: string) {\r\n  try {\r\n    const article = await prisma.article.findUnique({\r\n      where: { id: id }\r\n    });\r\n    \r\n    if (article) {\r\n      return { success: true, data: article };\r\n    }\r\n    return { success: false, error: \"æ–‡ç« æœªæ‰¾åˆ°\" };\r\n  } catch (error) {\r\n    console.error(error);\r\n    return { success: false, error: \"æŸ¥è¯¢å¤±è´¥\" };\r\n  }\r\n}"],"names":[],"mappings":";;;;;;;IAoIsB,cAAA,WAAA,GAAA,IAAA,kPAAA,EAAA,8CAAA,uOAAA,EAAA,KAAA,GAAA,6OAAA,EAAA"}},
    {"offset": {"line": 206, "column": 0}, "map": {"version":3,"sources":["file:///D:/%E8%BD%AF%E4%BB%B6%E9%A1%B9%E7%9B%AE%E7%AE%A1%E7%90%86%E5%AE%9E%E9%AA%8C/my-counseling-app/app/student/dashboard/page.tsx"],"sourcesContent":["\"use client\";\r\n\r\nimport { useEffect, useState } from 'react';\r\nimport Link from 'next/link';\r\nimport { useAppStore } from '@/lib/store';\r\nimport { Card, CardContent } from '@/components/ui/card';\r\nimport { Button } from '@/components/ui/button';\r\nimport { Badge } from '@/components/ui/badge';\r\n// âœ… 1. æ–°å¢ Bot å›¾æ ‡å¼•ç”¨\r\nimport { CalendarDays, BookOpen, Activity, Clock, User, Bot } from 'lucide-react';\r\nimport { getAppointments, getArticles } from '@/app/actions';\r\n\r\nexport default function StudentDashboard() {\r\n  const { currentUser } = useAppStore();\r\n  \r\n  const [appointments, setAppointments] = useState<any[]>([]);\r\n  const [articles, setArticles] = useState<any[]>([]);\r\n  const [loading, setLoading] = useState(true);\r\n\r\n  // è¿›é¡µé¢åŠ è½½æ•°æ®\r\n  useEffect(() => {\r\n    async function loadData() {\r\n      if (currentUser?.id) {\r\n        try {\r\n          // å¹¶è¡Œè¯·æ±‚æ•°æ®\r\n          const [apptData, artData] = await Promise.all([\r\n            getAppointments(currentUser.id, 'student'),\r\n            getArticles()\r\n          ]);\r\n          \r\n          setAppointments(apptData || []); \r\n          setArticles(artData || []);\r\n        } catch (error) {\r\n          console.error(\"æ•°æ®åŠ è½½å¤±è´¥\", error);\r\n        } finally {\r\n          setLoading(false);\r\n        }\r\n      }\r\n    }\r\n    loadData();\r\n  }, [currentUser]);\r\n\r\n  // è®¡ç®—å³å°†åˆ°æ¥çš„é¢„çº¦\r\n  const upcomingAppointments = appointments.filter(apt => \r\n    apt.status === 'confirmed' || apt.status === 'pending'\r\n  );\r\n\r\n  return (\r\n    <div className=\"space-y-8\">\r\n      {/* æ¬¢è¿å¤´éƒ¨ */}\r\n      <div className=\"flex justify-between items-end border-b border-gray-100 pb-6\">\r\n        <div>\r\n          <h1 className=\"text-3xl font-bold text-[#2C3E50]\">\r\n            æ—©å®‰ï¼Œ{currentUser?.name || 'åŒå­¦'} ğŸ‘‹\r\n          </h1>\r\n          <p className=\"text-slate-500 mt-2\">ä»Šå¤©æ˜¯ {new Date().toLocaleDateString()}ï¼Œç¥ä½ æ‹¥æœ‰ç¾å¥½çš„ä¸€å¤©ã€‚</p>\r\n        </div>\r\n        <Link href=\"/student/booking\">\r\n          <Button className=\"bg-[#5D9C59] hover:bg-[#3E6D3B] text-white shadow-md\">\r\n            + å‘èµ·æ–°é¢„çº¦\r\n          </Button>\r\n        </Link>\r\n      </div>\r\n\r\n      {/* å¿«æ·å…¥å£å¡ç‰‡åŒºåŸŸ */}\r\n      {/* âœ… 2. ä¿®æ”¹å¸ƒå±€ï¼šé€‚é… 4 ä¸ªå¡ç‰‡ (å¤§å±æ˜¾ç¤º4åˆ—ï¼Œä¸­å±æ˜¾ç¤º2åˆ—) */}\r\n      <div className=\"grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6\">\r\n        \r\n        {/* å¡ç‰‡1: å¿ƒç†å’¨è¯¢ */}\r\n        <Link href=\"/student/booking\">\r\n          <Card className=\"hover:shadow-lg transition-all cursor-pointer border-t-4 border-t-[#5D9C59] group h-full\">\r\n            <CardContent className=\"p-6 flex items-center gap-4\">\r\n              <div className=\"w-12 h-12 rounded-full bg-[#F0F7EF] flex items-center justify-center text-[#5D9C59] group-hover:bg-[#5D9C59] group-hover:text-white transition-colors\">\r\n                <CalendarDays className=\"w-6 h-6\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-bold text-lg text-[#2C3E50]\">å¿ƒç†å’¨è¯¢</h3>\r\n                <p className=\"text-sm text-slate-500\">é¢„çº¦ä¸“ä¸šå’¨è¯¢å¸ˆ</p>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </Link>\r\n\r\n        {/* âœ… 3. æ–°å¢å¡ç‰‡: AI å¿ƒç†åŠ©æ‰‹ */}\r\n        <Link href=\"/student/ai-companion\">\r\n          <Card className=\"hover:shadow-lg transition-all cursor-pointer border-t-4 border-t-purple-500 group h-full\">\r\n            <CardContent className=\"p-6 flex items-center gap-4\">\r\n              <div className=\"w-12 h-12 rounded-full bg-purple-50 flex items-center justify-center text-purple-600 group-hover:bg-purple-600 group-hover:text-white transition-colors\">\r\n                <Bot className=\"w-6 h-6\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-bold text-lg text-[#2C3E50]\">AI å¿ƒç†åŠ©æ‰‹</h3>\r\n                <p className=\"text-sm text-slate-500\">24h æ™ºèƒ½é™ªä¼´</p>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </Link>\r\n\r\n        {/* å¡ç‰‡3: å¿ƒç†æµ‹è¯„ */}\r\n        <Link href=\"/student/assessment\">\r\n          <Card className=\"hover:shadow-lg transition-all cursor-pointer border-t-4 border-t-blue-500 group h-full\">\r\n            <CardContent className=\"p-6 flex items-center gap-4\">\r\n              <div className=\"w-12 h-12 rounded-full bg-blue-50 flex items-center justify-center text-blue-500 group-hover:bg-blue-500 group-hover:text-white transition-colors\">\r\n                <Activity className=\"w-6 h-6\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-bold text-lg text-[#2C3E50]\">å¿ƒç†æµ‹è¯„</h3>\r\n                <p className=\"text-sm text-slate-500\">äº†è§£å½“ä¸‹çŠ¶æ€</p>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </Link>\r\n\r\n        {/* å¡ç‰‡4: çŸ¥è¯†åº“ */}\r\n        <Link href=\"/student/articles\">\r\n          <Card className=\"hover:shadow-lg transition-all cursor-pointer border-t-4 border-t-orange-500 group h-full\">\r\n            <CardContent className=\"p-6 flex items-center gap-4\">\r\n              <div className=\"w-12 h-12 rounded-full bg-orange-50 flex items-center justify-center text-orange-500 group-hover:bg-orange-500 group-hover:text-white transition-colors\">\r\n                <BookOpen className=\"w-6 h-6\" />\r\n              </div>\r\n              <div>\r\n                <h3 className=\"font-bold text-lg text-[#2C3E50]\">çŸ¥è¯†åº“</h3>\r\n                <p className=\"text-sm text-slate-500\">é˜…è¯»è‡ªåŠ©æ–‡ç« </p>\r\n              </div>\r\n            </CardContent>\r\n          </Card>\r\n        </Link>\r\n      </div>\r\n\r\n      <div className=\"grid grid-cols-1 lg:grid-cols-3 gap-8\">\r\n        {/* å·¦ä¾§ï¼šæˆ‘çš„é¢„çº¦ */}\r\n        <div className=\"lg:col-span-2 space-y-6\">\r\n          <div className=\"flex justify-between items-center\">\r\n            <h2 className=\"text-xl font-bold text-[#2C3E50] flex items-center gap-2\">\r\n              <Clock className=\"w-5 h-5 text-[#5D9C59]\" /> æˆ‘çš„é¢„çº¦\r\n            </h2>\r\n            <Link href=\"/student/booking\" className=\"text-sm text-[#5D9C59] hover:underline\">æŸ¥çœ‹å…¨éƒ¨</Link>\r\n          </div>\r\n\r\n          <div className=\"space-y-4\">\r\n            {loading ? (\r\n               <div className=\"text-center py-10 text-slate-400\">æ•°æ®åŠ è½½ä¸­...</div>\r\n            ) : upcomingAppointments.length > 0 ? (\r\n              upcomingAppointments.map((apt) => (\r\n                <div key={apt.id} className=\"bg-white p-5 rounded-xl border border-slate-100 shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4\">\r\n                  <div className=\"flex items-center gap-4\">\r\n                    <div className=\"w-12 h-12 bg-slate-100 rounded-full flex items-center justify-center\">\r\n                       <User className=\"text-slate-400 w-6 h-6\" />\r\n                    </div>\r\n                    <div>\r\n                      <h4 className=\"font-bold text-[#2C3E50]\">{apt.counselor.name} è€å¸ˆ</h4>\r\n                      <div className=\"flex items-center gap-2 text-sm text-slate-500 mt-1\">\r\n                        <CalendarDays className=\"w-3 h-3\" />\r\n                        <span>{new Date(apt.date).toLocaleDateString()}</span>\r\n                        <span className=\"w-1 h-1 bg-slate-300 rounded-full\"></span>\r\n                        <span>{apt.time}</span>\r\n                      </div>\r\n                    </div>\r\n                  </div>\r\n                  <Badge variant={apt.status === 'confirmed' ? 'default' : 'secondary'} \r\n                    className={apt.status === 'confirmed' ? \"bg-[#5D9C59]\" : \"bg-orange-100 text-orange-600 hover:bg-orange-100\"}>\r\n                    {apt.status === 'confirmed' ? 'é¢„çº¦æˆåŠŸ' : 'ç­‰å¾…ç¡®è®¤'}\r\n                  </Badge>\r\n                </div>\r\n              ))\r\n            ) : (\r\n              <div className=\"bg-slate-50 rounded-xl p-8 text-center border border-dashed border-slate-200\">\r\n                <p className=\"text-slate-500 mb-4\">æš‚æ— å¾…è¿›è¡Œçš„é¢„çº¦</p>\r\n                <Link href=\"/student/booking\">\r\n                  <Button variant=\"outline\">å»é¢„çº¦</Button>\r\n                </Link>\r\n              </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n\r\n        {/* å³ä¾§ï¼šæ¨èé˜…è¯» */}\r\n        <div className=\"space-y-6\">\r\n          <div className=\"flex justify-between items-center\">\r\n            <h2 className=\"text-xl font-bold text-[#2C3E50] flex items-center gap-2\">\r\n              <BookOpen className=\"w-5 h-5 text-orange-500\" /> æ¨èé˜…è¯»\r\n            </h2>\r\n            <Link href=\"/student/articles\" className=\"text-sm text-slate-400 hover:text-slate-600\">æ›´å¤š</Link>\r\n          </div>\r\n\r\n          <div className=\"space-y-4\">\r\n            {articles.slice(0, 3).map((article) => (\r\n              <Link href=\"/student/articles\" key={article.id}>\r\n                <div className=\"group bg-white p-4 rounded-xl border border-slate-100 shadow-sm hover:shadow-md transition-all cursor-pointer\">\r\n                  <div className=\"flex gap-4\">\r\n                    <div className=\"w-20 h-20 bg-slate-100 rounded-lg overflow-hidden flex-shrink-0\">\r\n                      <img src={article.image || \"https://images.unsplash.com/photo-1499209974431-2761eb43a768?w=800&q=80\"} alt=\"\" className=\"w-full h-full object-cover\" />\r\n                    </div>\r\n                    <div className=\"flex-1\">\r\n                      <Badge variant=\"secondary\" className=\"mb-2 text-xs bg-[#F0F7EF] text-[#3E6D3B] hover:bg-[#F0F7EF] border-0\">\r\n                        {article.category}\r\n                      </Badge>\r\n                      <h4 className=\"font-bold text-[#2C3E50] text-sm line-clamp-2 group-hover:text-[#5D9C59] transition-colors\">\r\n                        {article.title}\r\n                      </h4>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </Link>\r\n            ))}\r\n            {articles.length === 0 && !loading && (\r\n              <div className=\"text-center text-slate-400 text-sm py-4\">æš‚æ— æ¨èæ–‡ç« </div>\r\n            )}\r\n          </div>\r\n        </div>\r\n      </div>\r\n    </div>\r\n  );\r\n}"],"names":[],"mappings":"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"}}]
}